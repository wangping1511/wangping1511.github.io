---
layout: article
aside:
  toc: true
title: MySQL 事务隔离级别
tags: ["MySQL"]
---

## 并发事务出现的情况

#### 脏读（Dirty Read）

> 一个事务读到了另一个事务未提交的数据

|      |     session A      |     session B     |
| :--: | :----------------: | :---------------: |
|  1   |       begin;       |                   |
|  2   | 原来 balance = 100 |      begin;       |
|  3   |                    | 修改 balance = 50 |
|  4   | 查询 balance = 50  |                   |
|  5   |      commit;       |                   |
|  6   |                    |     rollback;     |

由于 session B 回滚 balance 还是 100，session A 读的是 50

#### 不可重复读（Non-Repeatable Read）

> 一个事务能读到另一个事务提交的数据。（不可重复读在读未提交和读已提交隔离级别都可能会出现）

|      |     session A      |             session B             |
| :--: | :----------------: | :-------------------------------: |
|  1   |       begin;       |                                   |
|  2   | 查询 balance = 100 |                                   |
|  3   |                    | begin; 修改 balance = 50；commit; |
|  4   | 查询 balance = 50  |                                   |
|  5   |                    | begin; 修改 balance = 60；commit; |
|  6   | 查询 balance = 60  |                                   |
|  8   |      commit;       |                                   |

导致 session A 事务多次读取一条数据数据不一致

#### 幻读（Phantom）

> 与不可重复读非常类似，不可重复读面向的是“同一条记录”，而幻读面向的是“同一个范围”。（幻读在读未提交、读已提交、可重复读隔离级别都可能会出现）

|      |            session A             |             session B             |
| :--: | :------------------------------: | :-------------------------------: |
|  1   |              begin;              |                                   |
|  2   | 查询 balance > 0;  balance = 100 |                                   |
|  3   |                                  | begin; 新增 balance = 50；commit; |
|  4   | 查询 balance = 100,balance = 50  |                                   |
|  5   |             commit;              |                                   |

## 事务隔离级别

#### 读未提交（READ UNCOMMITTED）

在读未提交的事务隔离级别下 sessionA 可以读取到 sessionB 未提交的数据。可能发生脏读、不可重复读、幻读。

#### 读已提交（READ COMMITTED）

在读已提交的事务隔离级别下 sessionA 可以到取到 sessionB 已经提交的数据。可能发生不可重复读、幻读。

#### 可重复读（REPEATABLE READ）

在可重复读的事务隔离级别下 sessionA 需要在 sessionB 提交完事务且自己也提交了事务之后才能读取更新的数据。可重复读隔离级别解决了脏读和不可重复读的问题，但可能发生幻读问题。

#### 可串行化（SERIALIZABLE）

通过加锁方式实现

读读操作：不阻塞

读写操作：写操作阻塞，读事务提交后，才去进行写操作

写读操作：读操作阻塞，写事务提交后，才能去读

写写操作：阻塞

#### 比较隔离级别

|          | 脏读 | 不可重复读 | 幻读 |
| :------: | :--: | :--------: | :--: |
| 读未提交 | 可能 |    可能    | 可能 |
| 读已提交 | 不会 |    可能    | 可能 |
| 可重复读 | 不会 |    不会    | 可能 |
| 可串行化 | 不会 |    不会    | 不会 |

